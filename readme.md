# Pipeline для jenkins

## Исходные условия

Кластер _kubernetes_ с фиксированным набором namespace'ов, предназначенных для размещения dev окружений.

В _gitlab_ есть несколько репозиториев проектов с приложениями. Репозитории содержат как код для сборки приложений, так и _helm_ _chart_'ы с _deployment_'ами для размещения этих приложений в окружениях.

## Задача

Обеспечить для разработчиков удобный способ использования dev окружений при создании новых feature.

## Реализация

Для реализации был выбран _jenkins_ по нескольким причинам:

* сохранялся старый "ci/cd" в gitlab
* наличие плагинов для визуализации pipeline'ов

Дополнительные ограничения:

* при разработки одной feature в нескольких проектах должны использоваться одинаковые имена веток

### Схема

Для каждого тестового окружения в jenkins создаётся folder с набором свойств:

* учётная запись доступа к git репозиториям
* имя ветки в git репозиториях
* параметры доступа к кластеру kubernetes

В данном folder для каждого проекта создаётся pipeline на основе общего файла. В gitlab в данном проекте настраивается hook в созданный pipeline для уведомления об изменениях в репозитории.

При получении вызова от gitlab запускается pipeline, проверяется наличие ветки указанной в свойствах folder, если она есть, то происходит сборка и выкат из неё, если нет, то сборка и выкат из ветки по-умолчанию.

Таким образом достигается поддержание всего окружения в состоянии соответствующем последним изменениям, как для проектов на ветке по-умолчанию, так и для проектов с feature веткой.

Также для folder настраивается плагин визуализации отображающий процесс выполнения последнего пайплайн'а каждого проекта.

#### Пояснения к шагам pipeline

##### stage('check parameters')

Вывод переменных данного pipeline:
 * j_folder_git_rev - git-ревизия в проектах для данного окружения
 * j_folder_namespace - namespace для данного окружения
 * j_folder_kubeconfig - расположение kubeconfig файла на агенте
 * j_folder_registry - адрес docker registry
 * j_git_creds - учётные данные для доступа в git репозитории проектов

 ##### stage('checkout')

 Всвязи с тем, что hook'и от gitlab прилетают по изменениям в любых ветках, тут проверяется наличие ветки данного окружения и ветки по-умолчанию, выбирается имеющаяся, и далее проверяется, был ли вызов от гитлаб связан с изменениев в выбранной ветке. Если нет (изменения не в "нашей" ветке), то выполнение pipeline прекращается.

 Также на этом шаге есть функция создания slug из имени git-ревизии для использования при теггированиии docker-образов.

 ##### stage('build and push')

 Сборка с помощью плагина. Dockerfile предполагается в репозитории.

 ##### stage('helminstall')

 Используется `helm upgrade` - предполагается, что `install` уже когда-то был сделан.

 ##### stage('get replicaset')

 Для проверки выката используется проверка состояния последнего ReplicaSet создаваемого при выкате Deployment'a данного приложения.
